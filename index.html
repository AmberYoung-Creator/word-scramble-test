<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HSK3 Interactive Study App</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&family=Noto+Sans+SC:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Nunito', sans-serif;
            background-color: #fef3c7; /* Amber-50 */
        }
        .zh-text {
            font-family: 'Noto Sans SC', sans-serif;
        }
        .card-perspective {
            perspective: 1000px;
        }
        .card-inner {
            transition: transform 0.6s;
            transform-style: preserve-3d;
        }
        .card-flipped {
            transform: rotateY(180deg);
        }
        .card-front, .card-back {
            backface-visibility: hidden;
        }
        .card-back {
            transform: rotateY(180deg);
        }
        /* Animation for correct answer */
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        .animate-pop {
            animation: pop 0.2s ease-in-out;
        }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- DATA EXTRACTED FROM IMAGE & ENRICHED ---
        // Segments are manually created for the Sentence Builder game logic.
        const WORD_DATA = [
            { id: 1, hanzi: "æ¬", pinyin: "bÄn", en: "to move, to carry", ru: "Ð¿ÐµÑ€ÐµÐµÐ·Ð¶Ð°Ñ‚ÑŒ; Ð¿ÐµÑ€ÐµÐ´Ð²Ð¸Ð³Ð°Ñ‚ÑŒ", sentence: "æˆ‘æœ‹å‹æ¬å®¶äº†ã€‚", sentenceChunks: ["æˆ‘", "æœ‹å‹", "æ¬å®¶", "äº†"] },
            { id: 2, hanzi: "åŒ—æ–¹", pinyin: "bÄ›i fÄng", en: "north, northern part", ru: "ÑÐµÐ²ÐµÑ€", sentence: "æˆ‘å¦ˆå¦ˆæ˜¯åŒ—æ–¹äººã€‚", sentenceChunks: ["æˆ‘", "å¦ˆå¦ˆ", "æ˜¯", "åŒ—æ–¹äºº"] },
            { id: 3, hanzi: "æ‰“ç®—", pinyin: "dÇŽ suÃ n", en: "plan, to intend", ru: "Ð¿Ð»Ð°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ", sentence: "è¿™ä¸ªå‘¨æœ«æˆ‘æ‰“ç®—åŽ»æ—…æ¸¸ã€‚", sentenceChunks: ["è¿™ä¸ª", "å‘¨æœ«", "æˆ‘", "æ‰“ç®—", "åŽ»", "æ—…æ¸¸"] },
            { id: 4, hanzi: "å¸¦", pinyin: "dÃ i", en: "to take along, to bring", ru: "Ð±Ñ€Ð°Ñ‚ÑŒ Ñ ÑÐ¾Ð±Ð¾Ð¹", sentence: "å°æ—¶å€™çˆ¸å¦ˆå¸¸å¸¸å¸¦æˆ‘åŽ»æ—…æ¸¸ã€‚", sentenceChunks: ["å°æ—¶å€™", "çˆ¸å¦ˆ", "å¸¸å¸¸", "å¸¦", "æˆ‘", "åŽ»", "æ—…æ¸¸"] },
            { id: 5, hanzi: "åœ°å›¾", pinyin: "dÃ¬ tÃº", en: "map", ru: "ÐºÐ°Ñ€Ñ‚Ð°", sentence: "æˆ‘å…ˆåœ¨åœ°å›¾ä¸Šçœ‹äº†ä¸€ä¸‹é‚£ä¸ªåœ°æ–¹ã€‚", sentenceChunks: ["æˆ‘", "å…ˆ", "åœ¨", "åœ°å›¾ä¸Š", "çœ‹äº†", "ä¸€ä¸‹", "é‚£ä¸ª", "åœ°æ–¹"] },
            { id: 6, hanzi: "å¤ä¹ ", pinyin: "fÃ¹ xÃ­", en: "to review", ru: "Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€ÑÑ‚ÑŒ (ÑƒÑ€Ð¾Ðº)", sentence: "æˆ‘æŠŠå­¦è¿‡çš„ä¸œè¥¿éƒ½å¤ä¹ äº†ä¸€éã€‚", sentenceChunks: ["æˆ‘", "æŠŠ", "å­¦è¿‡çš„", "ä¸œè¥¿", "éƒ½", "å¤ä¹ äº†", "ä¸€é"] },
            { id: 7, hanzi: "è·Ÿ", pinyin: "gÄ“n", en: "with", ru: "Ñ; ÑÐ»ÐµÐ´Ð¾Ð²Ð°Ñ‚ÑŒ", sentence: "æˆ‘è·Ÿæœ‹å‹éƒ½å¾ˆå–œæ¬¢å–èŒ¶ã€‚", sentenceChunks: ["æˆ‘", "è·Ÿ", "æœ‹å‹", "éƒ½", "å¾ˆ", "å–œæ¬¢", "å–èŒ¶"] },
            { id: 8, hanzi: "é¢åŒ…", pinyin: "miÃ n bÄo", en: "bread", ru: "Ñ…Ð»ÐµÐ±", sentence: "è¿™å®¶è¶…å¸‚çš„é¢åŒ…åˆå¥½åƒåˆä¾¿å®œã€‚", sentenceChunks: ["è¿™å®¶", "è¶…å¸‚çš„", "é¢åŒ…", "åˆ", "å¥½åƒ", "åˆ", "ä¾¿å®œ"] },
            { id: 9, hanzi: "å—æ–¹", pinyin: "nÃ¡n fÄng", en: "south, southern part", ru: "ÑŽÐ³", sentence: "ä»–æ˜¯åœ¨å—æ–¹å‡ºç”Ÿï¼Œåœ¨åŒ—æ–¹é•¿å¤§çš„ã€‚", sentenceChunks: ["ä»–æ˜¯", "åœ¨", "å—æ–¹", "å‡ºç”Ÿ", "åœ¨", "åŒ—æ–¹", "é•¿å¤§çš„"] },
            { id: 10, hanzi: "ä¸€ç›´", pinyin: "yÄ« zhÃ­", en: "all the time", ru: "Ð¿Ð¾ÑÑ‚Ð¾ÑÐ½Ð½Ð¾; Ð²ÑÑ‘ Ð²Ñ€ÐµÐ¼Ñ", sentence: "ä»–ä¸€ç›´éƒ½åœ¨é‚£ä¸ªå­¦æ ¡å½“è‹±è¯­è€å¸ˆã€‚", sentenceChunks: ["ä»–", "ä¸€ç›´", "éƒ½åœ¨", "é‚£ä¸ª", "å­¦æ ¡", "å½“", "è‹±è¯­è€å¸ˆ"] },
            { id: 11, hanzi: "æ¸¸æˆ", pinyin: "yÃ³u xÃ¬", en: "game", ru: "Ð¸Ð³Ñ€Ð°", sentence: "å¾ˆå¤šäººå–œæ¬¢çŽ©ç”µè„‘æ¸¸æˆã€‚", sentenceChunks: ["å¾ˆå¤š", "äºº", "å–œæ¬¢", "çŽ©", "ç”µè„‘", "æ¸¸æˆ"] },
            { id: 12, hanzi: "ç€æ€¥", pinyin: "zhÃ¡o jÃ­", en: "worried, anxious", ru: "Ð²Ð¾Ð»Ð½Ð¾Ð²Ð°Ñ‚ÑŒÑÑ", sentence: "é’¥åŒ™ä¸¢äº†ï¼Œæˆ‘å¾ˆç€æ€¥ã€‚", sentenceChunks: ["é’¥åŒ™", "ä¸¢äº†", "æˆ‘", "å¾ˆ", "ç€æ€¥"] },
            { id: 13, hanzi: "å‘¨æœ«", pinyin: "zhÅu mÃ²", en: "weekend", ru: "Ð²Ñ‹Ñ…Ð¾Ð´Ð½Ñ‹Ðµ", sentence: "æˆ‘ä»¬ä¸Šå‘¨æœ«åŽ»çˆ¬å±±äº†ã€‚", sentenceChunks: ["æˆ‘ä»¬", "ä¸Šå‘¨æœ«", "åŽ»", "çˆ¬å±±", "äº†"] },
            { id: 14, hanzi: "ä½œä¸š", pinyin: "zuÃ² yÃ¨", en: "homework", ru: "Ð´Ð¾Ð¼Ð°ÑˆÐ½ÐµÐµ Ð·Ð°Ð´Ð°Ð½Ð¸Ðµ", sentence: "ä»Šå¤©çš„ä½œä¸šæ˜¯ä»€ä¹ˆï¼Ÿ", sentenceChunks: ["ä»Šå¤©çš„", "ä½œä¸š", "æ˜¯", "ä»€ä¹ˆ"] },
            { id: 15, hanzi: "æŠŠ", pinyin: "bÇŽ", en: "particle / handful", ru: "Ñ‡Ð°ÑÑ‚Ð¸Ñ†Ð° ba / ÑÐ²ÑÐ·ÐºÐ°", sentence: "æˆ‘ä¹°äº†ä¸€æŠŠæ¤…å­ã€‚", sentenceChunks: ["æˆ‘", "ä¹°äº†", "ä¸€æŠŠ", "æ¤…å­"] },
            { id: 16, hanzi: "åŠžå…¬å®¤", pinyin: "bÃ n gÅng shÃ¬", en: "office", ru: "Ð¾Ñ„Ð¸Ñ", sentence: "æˆ‘åœ¨æ‰¾çŽ‹è€å¸ˆçš„åŠžå…¬å®¤ã€‚", sentenceChunks: ["æˆ‘", "åœ¨", "æ‰¾", "çŽ‹è€å¸ˆçš„", "åŠžå…¬å®¤"] },
            { id: 17, hanzi: "è„š", pinyin: "jiÇŽo", en: "foot", ru: "Ð½Ð¾Ð³Ð°; ÑÑ‚ÑƒÐ¿Ð½Ñ", sentence: "ä»–çš„è„šä¸Šç©¿ç€è¿åŠ¨éž‹ã€‚", sentenceChunks: ["ä»–çš„", "è„šä¸Š", "ç©¿ç€", "è¿åŠ¨éž‹"] },
            { id: 18, hanzi: "ç»ç†", pinyin: "jÄ«ng lÇ", en: "manager", ru: "Ð¼ÐµÐ½ÐµÐ´Ð¶ÐµÑ€; Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€", sentence: "æˆ‘ä»¬å…¬å¸æ¥äº†ä¸€ä¸ªæ–°ç»ç†ã€‚", sentenceChunks: ["æˆ‘ä»¬", "å…¬å¸", "æ¥äº†", "ä¸€ä¸ª", "æ–°", "ç»ç†"] },
            { id: 19, hanzi: "è¾†", pinyin: "liÃ ng", en: "m.w. for vehicles", ru: "ÑÑ‡. ÑÐ». Ð´Ð»Ñ Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚Ð°", sentence: "é‚£è¾†å…¬äº¤è½¦åˆšå¼€èµ°ã€‚", sentenceChunks: ["é‚£è¾†", "å…¬äº¤è½¦", "åˆš", "å¼€èµ°"] },
            { id: 20, hanzi: "æ¥¼", pinyin: "lÃ³u", en: "building, floor", ru: "Ð·Ð´Ð°Ð½Ð¸Ðµ; ÑÑ‚Ð°Ð¶", sentence: "ä½ å®¶ä½åœ¨å‡ æ¥¼ï¼Ÿ", sentenceChunks: ["ä½ å®¶", "ä½åœ¨", "å‡ æ¥¼"] },
            { id: 21, hanzi: "æ‹¿", pinyin: "nÃ¡", en: "to take, to fetch", ru: "Ð±Ñ€Ð°Ñ‚ÑŒ; Ð´ÐµÑ€Ð¶Ð°Ñ‚ÑŒ", sentence: "æˆ‘å¿˜å¸¦æ‰‹æœºäº†ï¼Œæˆ‘è¦å›žå®¶æ‹¿ã€‚", sentenceChunks: ["æˆ‘", "å¿˜å¸¦", "æ‰‹æœºäº†", "æˆ‘è¦", "å›žå®¶", "æ‹¿"] },
        ];

        // --- UTILS ---
        const speak = (text, lang = 'zh-CN') => {
            if (!window.speechSynthesis) return;
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = lang;
            utterance.rate = 0.8; // Slightly slower for learners
            window.speechSynthesis.speak(utterance);
        };

        const shuffleArray = (array) => {
            const newArr = [...array];
            for (let i = newArr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArr[i], newArr[j]] = [newArr[j], newArr[i]];
            }
            return newArr;
        };

        // --- COMPONENTS ---

        const ProgressBar = ({ current, total, label }) => (
            <div className="w-full bg-amber-200 rounded-full h-4 mb-4 relative overflow-hidden">
                <div 
                    className="bg-amber-500 h-4 rounded-full transition-all duration-500" 
                    style={{ width: `${(current / total) * 100}%` }}
                ></div>
                <span className="absolute top-0 left-0 w-full text-center text-[10px] text-amber-900 font-bold leading-4">
                    {label} ({current}/{total})
                </span>
            </div>
        );

        // 1. FLASHCARD COMPONENT
        const FlashcardMode = ({ words, onUpdateMastery }) => {
            const [index, setIndex] = useState(0);
            const [flipped, setFlipped] = useState(false);
            
            const currentWord = words[index];

            const handleNext = (masteryIncrement) => {
                if (masteryIncrement > 0) onUpdateMastery(currentWord.id, 1);
                setFlipped(false);
                setTimeout(() => {
                    setIndex((prev) => (prev + 1) % words.length);
                }, 200);
            };

            // Keyboard shortcuts
            useEffect(() => {
                const handleKey = (e) => {
                    if (e.code === 'Space') {
                        e.preventDefault();
                        setFlipped(p => !p);
                    }
                    if (e.key.toLowerCase() === 'k' && flipped) handleNext(1);
                    if (e.key.toLowerCase() === 'a' && flipped) handleNext(0);
                    if (e.key.toLowerCase() === 'v') speak(currentWord.hanzi);
                };
                window.addEventListener('keydown', handleKey);
                return () => window.removeEventListener('keydown', handleKey);
            }, [flipped, index]);

            return (
                <div className="flex flex-col items-center w-full max-w-sm mx-auto mt-4">
                    <ProgressBar current={index + 1} total={words.length} label="Deck Progress" />
                    
                    <div 
                        className="card-perspective w-full h-80 cursor-pointer group" 
                        onClick={() => setFlipped(!flipped)}
                    >
                        <div className={`card-inner w-full h-full relative rounded-2xl shadow-xl duration-500 ${flipped ? 'card-flipped' : ''}`}>
                            {/* Front */}
                            <div className="card-front absolute w-full h-full bg-white rounded-2xl flex flex-col items-center justify-center p-6 border-2 border-amber-100">
                                <span className="text-sm text-amber-500 font-bold mb-2">HANZI</span>
                                <h1 className="zh-text text-7xl text-gray-800 font-bold mb-4">{currentWord.hanzi}</h1>
                                <div className="mt-8 text-gray-400 text-sm italic">(Press Space to Flip)</div>
                            </div>

                            {/* Back */}
                            <div className="card-back absolute w-full h-full bg-amber-50 rounded-2xl flex flex-col items-center justify-center p-6 border-2 border-amber-200">
                                <div className="text-center">
                                    <h2 className="text-2xl text-amber-600 font-bold mb-1">{currentWord.pinyin}</h2>
                                    <button 
                                        onClick={(e) => { e.stopPropagation(); speak(currentWord.hanzi); }}
                                        className="mb-4 p-2 bg-amber-100 rounded-full hover:bg-amber-200 text-amber-600 transition-colors"
                                    >
                                        <i className="ph ph-speaker-high text-xl"></i>
                                    </button>
                                    
                                    <div className="bg-white p-3 rounded-lg shadow-sm w-full mb-2">
                                        <span className="text-xs text-gray-400 font-bold uppercase">English</span>
                                        <p className="text-gray-800 font-medium">{currentWord.en}</p>
                                    </div>
                                    
                                    <div className="bg-white p-3 rounded-lg shadow-sm w-full">
                                        <span className="text-xs text-gray-400 font-bold uppercase">Russian</span>
                                        <p className="text-gray-800 font-medium">{currentWord.ru}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {/* Controls */}
                    <div className="flex gap-4 mt-8 w-full">
                        <button 
                            onClick={() => handleNext(0)}
                            className="flex-1 py-3 bg-rose-100 text-rose-600 font-bold rounded-xl hover:bg-rose-200 transition shadow-sm border border-rose-200"
                        >
                            (A)gain
                        </button>
                        <button 
                            onClick={() => handleNext(1)}
                            className="flex-1 py-3 bg-emerald-100 text-emerald-600 font-bold rounded-xl hover:bg-emerald-200 transition shadow-sm border border-emerald-200"
                        >
                            (K)new it
                        </button>
                    </div>
                </div>
            );
        };

        // 2. QUIZ COMPONENT
        const QuizMode = ({ words }) => {
            const [current, setCurrent] = useState(null);
            const [options, setOptions] = useState([]);
            const [status, setStatus] = useState('guessing'); // guessing, correct, wrong
            const [stats, setStats] = useState({ correct: 0, total: 0 });

            const generateQuestion = () => {
                const target = words[Math.floor(Math.random() * words.length)];
                const distractors = shuffleArray(words.filter(w => w.id !== target.id)).slice(0, 3);
                const allOptions = shuffleArray([target, ...distractors]);
                setCurrent(target);
                setOptions(allOptions);
                setStatus('guessing');
            };

            useEffect(() => {
                generateQuestion();
            }, []);

            const handleGuess = (wordId) => {
                if (status !== 'guessing') return;
                setStats(s => ({ ...s, total: s.total + 1 }));
                if (wordId === current.id) {
                    setStatus('correct');
                    setStats(s => ({ ...s, correct: s.correct + 1 }));
                    speak(current.hanzi);
                } else {
                    setStatus('wrong');
                }
            };

            if (!current) return <div>Loading...</div>;

            return (
                <div className="w-full max-w-sm mx-auto mt-6">
                    <div className="flex justify-between text-amber-800 font-bold mb-4 px-2">
                        <span>Score: {stats.correct}</span>
                        <span>Total: {stats.total}</span>
                    </div>

                    <div className="bg-white p-8 rounded-2xl shadow-lg border-b-4 border-amber-200 text-center mb-6">
                        <h2 className="zh-text text-6xl font-bold text-gray-800 mb-2">{current.hanzi}</h2>
                        <p className="text-gray-400 font-mono">{status !== 'guessing' ? current.pinyin : '???'}</p>
                    </div>

                    <div className="grid grid-cols-1 gap-3">
                        {options.map(opt => (
                            <button
                                key={opt.id}
                                onClick={() => handleGuess(opt.id)}
                                disabled={status !== 'guessing'}
                                className={`p-4 rounded-xl text-left transition font-medium border-2 
                                    ${status === 'guessing' ? 'bg-white border-transparent shadow hover:bg-amber-50' : ''}
                                    ${status === 'correct' && opt.id === current.id ? 'bg-green-100 border-green-400 text-green-800' : ''}
                                    ${status === 'wrong' && opt.id === current.id ? 'bg-green-100 border-green-400 text-green-800' : ''}
                                    ${status === 'wrong' && opt.id !== current.id ? 'bg-red-50 border-red-200 opacity-50' : ''}
                                `}
                            >
                                <div className="text-gray-800">{opt.en}</div>
                                <div className="text-gray-500 text-xs">{opt.ru}</div>
                            </button>
                        ))}
                    </div>

                    {status !== 'guessing' && (
                        <button 
                            onClick={generateQuestion}
                            className="w-full mt-6 py-3 bg-amber-500 text-white font-bold rounded-xl shadow-lg hover:bg-amber-600 transition"
                        >
                            Next Word <i className="ph ph-arrow-right ml-2"></i>
                        </button>
                    )}
                </div>
            );
        };

        // 3. SENTENCE BUILDER COMPONENT
        const SentenceBuilder = ({ words }) => {
            const [currentQ, setCurrentQ] = useState(0);
            const [userOrder, setUserOrder] = useState([]);
            const [bank, setBank] = useState([]);
            const [isCorrect, setIsCorrect] = useState(false);

            const currentWord = words[currentQ];

            useEffect(() => {
                resetLevel();
            }, [currentQ]);

            const resetLevel = () => {
                // Clean punctuation for the puzzle pieces
                const chunks = currentWord.sentenceChunks;
                setBank(shuffleArray(chunks.map((c, i) => ({ id: i, text: c }))));
                setUserOrder([]);
                setIsCorrect(false);
            };

            const handleBankClick = (item) => {
                setBank(bank.filter(i => i.id !== item.id));
                const newOrder = [...userOrder, item];
                setUserOrder(newOrder);
                checkWin(newOrder);
            };

            const handleSlotClick = (item) => {
                if(isCorrect) return;
                setUserOrder(userOrder.filter(i => i.id !== item.id));
                setBank([...bank, item]);
            };

            const checkWin = (order) => {
                const constructed = order.map(o => o.text).join('');
                // Simple check: remove punctuation from target to compare loosely or check exact chunks
                // Since we are using chunks, we check if the chunks align
                const target = currentWord.sentenceChunks.join('');
                
                if (constructed === target) {
                    setIsCorrect(true);
                    speak(currentWord.sentence);
                }
            };

            const nextLevel = () => {
                setCurrentQ((prev) => (prev + 1) % words.length);
            };

            return (
                <div className="w-full max-w-md mx-auto mt-4 flex flex-col h-[calc(100vh-180px)]">
                    <ProgressBar current={currentQ + 1} total={words.length} label="Sentence Progress" />
                    
                    {/* Target Context */}
                    <div className="bg-white p-4 rounded-xl shadow-sm border-l-4 border-amber-400 mb-4">
                        <div className="text-sm text-gray-500 font-bold uppercase mb-1">Translate:</div>
                        <div className="text-lg text-gray-800 leading-tight">{currentWord.sentence} (Hidden)</div>
                        {/* Actually show the hint based on user request: Show English, build Chinese */}
                        <div className="text-lg text-gray-800 font-bold mt-1">"{currentWord.en}" (Context)</div>
                        <div className="text-sm text-gray-500 italic mt-2">Form the sentence using: <strong>{currentWord.hanzi}</strong></div>
                    </div>

                    {/* Drop Zone (Answer Area) */}
                    <div className={`flex-grow bg-amber-50 rounded-2xl p-4 border-2 border-dashed transition-colors flex content-start flex-wrap gap-2
                        ${isCorrect ? 'border-green-400 bg-green-50' : 'border-amber-300'}`}>
                        
                        {userOrder.length === 0 && !isCorrect && (
                            <div className="w-full text-center text-gray-400 mt-10">Tap words below to build sentence</div>
                        )}

                        {userOrder.map((item, idx) => (
                            <button 
                                key={item.id} 
                                onClick={() => handleSlotClick(item)}
                                className="zh-text bg-white px-3 py-2 rounded-lg shadow-sm text-lg border-b-2 border-gray-200 animate-pop"
                            >
                                {item.text}
                            </button>
                        ))}
                    </div>

                    {/* Success Modal / Next Button */}
                    {isCorrect && (
                        <div className="animate-pop my-4 p-4 bg-green-100 rounded-xl border border-green-300 text-center">
                            <h3 className="text-green-800 font-bold text-xl mb-1">Correct! ðŸŽ‰</h3>
                            <p className="zh-text text-2xl text-green-900 mb-2">{currentWord.sentence}</p>
                            <button 
                                onClick={nextLevel}
                                className="bg-green-600 text-white px-6 py-2 rounded-full font-bold shadow hover:bg-green-700"
                            >
                                Next Sentence
                            </button>
                        </div>
                    )}

                    {/* Word Bank */}
                    <div className="mt-4 grid grid-cols-4 gap-2">
                        {bank.map(item => (
                            <button 
                                key={item.id}
                                onClick={() => handleBankClick(item)}
                                className="zh-text bg-white p-2 rounded-lg shadow border border-amber-100 hover:bg-amber-50 text-lg transition-transform active:scale-95"
                            >
                                {item.text}
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        // 4. TYPE-IT MODE
        const TypeItMode = ({ words }) => {
            const [index, setIndex] = useState(0);
            const [input, setInput] = useState('');
            const [feedback, setFeedback] = useState(''); // '', 'correct', 'wrong'
            
            const word = words[index];

            const checkAnswer = (e) => {
                e.preventDefault();
                if (input.trim() === word.hanzi) {
                    setFeedback('correct');
                    speak(word.hanzi);
                } else {
                    setFeedback('wrong');
                    speak("Try again");
                }
            };

            const next = () => {
                setIndex((prev) => (prev + 1) % words.length);
                setInput('');
                setFeedback('');
            };

            return (
                <div className="w-full max-w-sm mx-auto mt-8 text-center">
                     <div className="bg-white p-6 rounded-2xl shadow-lg border border-amber-100 mb-6">
                        <span className="text-xs font-bold text-gray-400 uppercase">Type the Chinese Character for:</span>
                        <h2 className="text-2xl font-bold text-gray-800 mt-2">{word.en}</h2>
                        <p className="text-sm text-gray-500">{word.ru}</p>
                    </div>

                    <form onSubmit={checkAnswer} className="relative">
                        <input 
                            type="text" 
                            value={input}
                            onChange={(e) => setInput(e.target.value)}
                            placeholder="Type æ±‰å­— here..."
                            className={`zh-text w-full p-4 text-center text-3xl rounded-xl border-2 outline-none transition
                                ${feedback === 'correct' ? 'border-green-500 bg-green-50 text-green-900' : 'border-gray-200 focus:border-amber-400'}
                                ${feedback === 'wrong' ? 'border-red-400 bg-red-50' : ''}
                            `}
                        />
                        {feedback === 'correct' && (
                            <div className="mt-4">
                                <div className="text-green-600 font-bold mb-2">Correct! {word.pinyin}</div>
                                <button type="button" onClick={next} className="bg-amber-500 text-white px-8 py-2 rounded-full font-bold shadow">Next</button>
                            </div>
                        )}
                         {feedback === 'wrong' && (
                             <div className="mt-2 text-red-500 text-sm font-bold">Not quite. Answer: {word.hanzi}</div>
                         )}
                         {feedback === '' && <button type="submit" className="mt-4 text-amber-600 font-bold text-sm">Check Answer</button>}
                    </form>
                </div>
            );
        }

        // 5. LIST VIEW
        const ListView = ({ words }) => (
            <div className="w-full max-w-2xl mx-auto mt-8 bg-white rounded-xl shadow-sm overflow-hidden">
                <table className="w-full text-left">
                    <thead className="bg-amber-100 text-amber-800">
                        <tr>
                            <th className="p-3">æ±‰å­—</th>
                            <th className="p-3">Pinyin</th>
                            <th className="p-3">Meaning</th>
                        </tr>
                    </thead>
                    <tbody className="divide-y divide-gray-100">
                        {words.map(w => (
                            <tr key={w.id} className="hover:bg-amber-50 group cursor-pointer" onClick={() => speak(w.hanzi)}>
                                <td className="p-3 zh-text font-bold text-lg text-amber-600 group-hover:scale-110 transition-transform origin-left">{w.hanzi}</td>
                                <td className="p-3 text-gray-600">{w.pinyin}</td>
                                <td className="p-3 text-sm">
                                    <div className="font-bold text-gray-800">{w.en}</div>
                                    <div className="text-gray-400">{w.ru}</div>
                                </td>
                            </tr>
                        ))}
                    </tbody>
                </table>
            </div>
        );

        // --- MAIN APP ---
        const App = () => {
            const [mode, setMode] = useState('flashcard'); // flashcard, quiz, typeit, sentence, list
            const [mastery, setMastery] = useState({});

            useEffect(() => {
                const saved = localStorage.getItem('hsk3_mastery');
                if (saved) setMastery(JSON.parse(saved));
            }, []);

            const updateMastery = (id, score) => {
                const newMastery = { ...mastery, [id]: (mastery[id] || 0) + score };
                setMastery(newMastery);
                localStorage.setItem('hsk3_mastery', JSON.stringify(newMastery));
            };

            const navItems = [
                { id: 'flashcard', icon: 'ph-cards', label: 'Cards' },
                { id: 'quiz', icon: 'ph-question', label: 'Quiz' },
                { id: 'sentence', icon: 'ph-text-t', label: 'Builder' },
                { id: 'typeit', icon: 'ph-keyboard', label: 'Type' },
                { id: 'list', icon: 'ph-list', label: 'List' },
            ];

            return (
                <div className="min-h-screen flex flex-col bg-amber-50 pb-24">
                    {/* Header */}
                    <header className="bg-white shadow-sm sticky top-0 z-10 px-4 py-3 flex justify-between items-center">
                        <div className="flex items-center gap-2 text-amber-600">
                            <i className="ph-fill ph-translate text-2xl"></i>
                            <h1 className="font-extrabold text-xl tracking-tight">HSK3 Master</h1>
                        </div>
                        <div className="text-xs font-bold bg-amber-100 text-amber-700 px-2 py-1 rounded">
                            Words: {WORD_DATA.length}
                        </div>
                    </header>

                    {/* Content Area */}
                    <main className="flex-grow px-4 py-4">
                        {mode === 'flashcard' && <FlashcardMode words={WORD_DATA} onUpdateMastery={updateMastery} />}
                        {mode === 'quiz' && <QuizMode words={WORD_DATA} />}
                        {mode === 'sentence' && <SentenceBuilder words={WORD_DATA} />}
                        {mode === 'typeit' && <TypeItMode words={WORD_DATA} />}
                        {mode === 'list' && <ListView words={WORD_DATA} />}
                    </main>

                    {/* Bottom Navigation */}
                    <nav className="fixed bottom-0 left-0 w-full bg-white border-t border-amber-100 pb-safe px-4 py-2 flex justify-around items-center shadow-lg z-50">
                        {navItems.map(item => (
                            <button
                                key={item.id}
                                onClick={() => setMode(item.id)}
                                className={`flex flex-col items-center gap-1 p-2 rounded-xl transition-all duration-300 ${mode === item.id ? 'text-amber-600 -translate-y-2 bg-amber-50' : 'text-gray-400 hover:text-amber-400'}`}
                            >
                                <i className={`ph ${item.icon} text-2xl`}></i>
                                <span className="text-[10px] font-bold uppercase tracking-wider">{item.label}</span>
                            </button>
                        ))}
                    </nav>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
